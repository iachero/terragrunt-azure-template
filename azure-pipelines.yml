trigger:
  branches:
    include:
    - main
    - feature/*
  paths:
    include:
    - terraform/**
    - terragrunt/**

parameters:
  - name: action
    displayName: |
      üîß A√ß√£o a executar:
      - init: Inicializa o Terragrunt
      - validate: Valida a configura√ß√£o
      - plan: Gera plano de execu√ß√£o
      - apply: Aplica mudan√ßas
      - destroy: Remove infraestrutura
      - output: Mostra outputs
    default: plan
    type: string
    values:
      - init
      - validate
      - plan
      - apply
      - destroy
      - output
  - name: environment
    displayName: 'üåê Ambiente'
    default: 'dev'
    type: string
    values:
      - dev
      - hml
      - prod

  - name: region
    displayName: 'üåç Regi√£o'
    default: 'eastus2'
    type: string
    values:
      - eastus2
      - brazilsouth

variables:
  # Vari√°veis do ambiente
  TERRAFORM_VERSION: '1.10.5'
  TERRAGRUNT_VERSION: '0.73.14'
  
  # Definir ambiente default (ser√° substitu√≠do pelos par√¢metros do pipeline)
  ENV_NAME: ${{ parameters.environment }}
  REGION: ${{ parameters.region }}
  
  # Configura√ß√µes do backend (opcional, pode ser substitu√≠do pelas vari√°veis de ambiente ARM_*)
  TF_STATE_RG: 'rg-terragrunt-state'
  TF_STATE_SA: 'stterragruntstate'
  TF_STATE_CONTAINER: 'tg-tfstate'

stages:
- stage: Infrastructure
  displayName: 'üèóÔ∏è Infraestrutura como C√≥digo'
  jobs:
  - job: TerragruntJob
    displayName: 'üöÄ Terragrunt ${{ parameters.action }}'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    # Instalar Terraform e Terragrunt apenas uma vez por job
    - bash: |
        echo "Instalando Terraform v$(TERRAFORM_VERSION)..."
        curl -LO "https://releases.hashicorp.com/terraform/$(TERRAFORM_VERSION)/terraform_$(TERRAFORM_VERSION)_linux_amd64.zip"
        sudo apt-get update && sudo apt-get install -y unzip
        unzip terraform_$(TERRAFORM_VERSION)_linux_amd64.zip
        sudo mv terraform /usr/local/bin/
        terraform --version

        echo "Instalando Terragrunt v$(TERRAGRUNT_VERSION)..."
        curl -LO "https://github.com/gruntwork-io/terragrunt/releases/download/v$(TERRAGRUNT_VERSION)/terragrunt_linux_amd64"
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
        terragrunt --version
      displayName: '‚öôÔ∏è Instalar Terraform e Terragrunt'

    # Valida√ß√£o de c√≥digo (somente quando a a√ß√£o n√£o √© destroy)
    - bash: |
        echo "Formatando e validando arquivos Terraform..."
        terraform fmt --check --recursive ./terraform || true
        
        echo "Formatando e validando arquivos Terragrunt..."
        terragrunt hclfmt --check --working-dir ./terragrunt || true
      # terragrunt hclvalidate --working-dir ./terragrunt || true
      displayName: '‚úÖ Validar formata√ß√£o e sintaxe'
      condition: and(succeeded(), ne('${{ parameters.action }}', 'destroy'))

    # Executar a√ß√£o do Terragrunt baseada no par√¢metro
    - task: AzureCLI@2
      displayName: 'üîÑ Terragrunt ${{ parameters.action }}'
      inputs:
        azureSubscription: 'SP-MPN'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e
          echo "Executando Terragrunt ${{ parameters.action }} para $(ENV_NAME) em $(REGION)"
          
          # Navegando para o diret√≥rio do ambiente
          cd terragrunt/environments/$(ENV_NAME)/$(REGION)
          
          # Executando a a√ß√£o solicitada
          case "${{ parameters.action }}" in
            init)
              terragrunt run-all init --non-interactive
              ;;
            validate)
              terragrunt run-all validate --non-interactive
              ;;
            plan)
              # Criar diret√≥rio para planos
              mkdir -p $(Build.ArtifactStagingDirectory)/plans
              
              # Gerar plano detalhado
              terragrunt run-all plan --non-interactive --out=$(Build.ArtifactStagingDirectory)/plans/tfplan.binary
              
              # Criar resumo leg√≠vel do plano
              cd $(Build.ArtifactStagingDirectory)/plans
              if [ -f "tfplan.binary" ]; then
                terraform show -no-color tfplan.binary > plan.txt
                echo "Resumo do plano:" > plan_summary.txt
                cat plan.txt | grep -E 'Plan:|will be created|will be destroyed|will be updated' >> plan_summary.txt
                echo "---"
                cat plan_summary.txt
              fi
              ;;
            apply)
              terragrunt run-all apply --non-interactive --auto-approve
              ;;
            destroy)
              terragrunt run-all destroy --non-interactive --auto-approve
              ;;
          esac

    # Publicar artefatos se estiver em modo de plano
    - task: PublishPipelineArtifact@1
      displayName: 'üì¶ Publicar artefatos do plano'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/plans'
        artifact: 'TerraformPlan'
        publishLocation: 'pipeline'
      condition: and(succeeded(), eq('${{ parameters.action }}', 'plan'))

    # Outputs em caso de apply
    - bash: |
        if [ "${{ parameters.action }}" == "apply" ]; then
          echo "Coletando outputs..."
          cd terragrunt/environments/$(ENV_NAME)/$(REGION)
          terragrunt run-all output --non-interactive || true
        fi
      displayName: 'üìã Mostrar outputs (somente apply)'
      condition: and(succeeded(), eq('${{ parameters.action }}', 'apply'))

- stage: Validation
  displayName: 'üîç Valida√ß√£o'
  dependsOn: Infrastructure
  # Somente executar est√°gio de valida√ß√£o ap√≥s aplicar mudan√ßas em produ√ß√£o
  condition: and(succeeded(), eq('${{ parameters.action }}', 'apply'), eq('${{ parameters.environment }}', 'prod'))
  jobs:
  - job: ValidationJob
    displayName: '‚úì Validar Implanta√ß√£o'
    pool: server
    steps:
    - task: ManualValidation@1
      timeoutInMinutes: 1440 # 24 horas
      inputs:
        notifyUsers: '$(BUILD_REQUESTEDFOR)'
        instructions: 'Por favor, valide a implanta√ß√£o em produ√ß√£o e confirme se est√° tudo correto.'
        onTimeout: 'resume'